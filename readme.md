# Media Luna

> 本项目纯 Vibe Coding 生成，感谢 Claude 大力支持。

中间件驱动的多媒体生成插件，支持多种 AI 图像生成服务和 WebUI 管理。

## 功能特性

- **多连接器支持**：DALL-E、Stable Diffusion WebUI、Flux、通用 Chat API 等
- **预设系统**：创建和管理提示词模板，支持远程同步
- **中间件管道**：灵活的请求处理流程，支持计费、缓存、翻译等
- **WebUI 管理**：通过 Koishi Console 进行可视化配置
- **任务记录**：完整的生成历史和统计

## 安装

```bash
# 通过 Koishi 插件市场安装
# 或手动安装
npm install koishi-plugin-media-luna
```

## 快速开始

### 1. 安装并启用插件

在 Koishi 控制台的插件市场搜索 `media-luna` 并安装。

### 2. 配置连接器

进入 Media Luna 的设置页面，在「插件」标签页启用并配置所需的连接器：

- **DALL-E**：需要 OpenAI API Key
- **SD WebUI**：需要 Stable Diffusion WebUI 的地址
- **Flux**：需要 Flux API 地址和密钥
- **Chat API**：支持兼容 OpenAI 格式的图像生成 API

### 3. 创建渠道

在「渠道」页面创建新渠道：

1. 填写渠道名称（如 `dalle`）
2. 选择连接器
3. 配置连接器参数（API Key、模型等）
4. 添加标签（用于指令匹配）

### 4. 创建预设（可选）

在「预设」页面创建提示词模板：

```
realistic photo, {{userText}}, high quality, 8k, detailed
```

`{{userText}}` 会被用户输入的提示词替换。

### 5. 使用

在聊天中使用命令生成图片：

```
画图 一只可爱的猫咪
```

或通过 WebUI 的「生成」页面直接生成。

## 配置说明

### 插件配置

在 Koishi 插件配置页面可以设置：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| logLevel | 日志级别 | info |

### 连接器配置

各连接器的详细配置请参考对应的设置页面。

### 中间件配置

在「设置」→「中间件」页面配置各中间件的行为：

- **计费 (billing)**：启用/禁用计费，配置货币提供者
- **预设 (preset)**：自动应用预设模板
- **缓存 (cache)**：资源缓存设置
- **任务记录 (task)**：任务保留时间

## WebUI 页面

| 页面 | 功能 |
|------|------|
| 生成 | 直接在浏览器中生成图片 |
| 渠道 | 管理生成渠道配置 |
| 预设 | 管理提示词预设模板 |
| 任务 | 查看生成历史和统计 |
| 设置 | 全局设置和插件配置 |

## 指令使用说明

### 查询指令

| 指令 | 说明 |
|------|------|
| `models` | 查看所有可用模型名 |
| `presets` | 查看所有预设名 |
| `preset <预设名>` | 查看具体预设内容 |
| `loras` | 查看已挑选的 LoRA 列表 |
| `mytasks` | 查看我的任务列表 |
| `taskinfo <id>` | 查看任务详情 |

### 基础用法

**格式：** `渠道名 [预设名] 文字 [图片...]`

1. **完整指定**：`渠道名 预设名 文字 【图片1】【图片2】`
   - 附带 2 张或以上图片时直接触发画图

2. **省略预设**：`渠道名 文字 【图片1】【图片2】`
   - 无需指定预设也能触发（文字不能正好等于预设名）

3. **收集模式**：`渠道名 预设名 文字 【图片1】`
   - 图片少于 2 张时进入收集模式
   - 收集接下来的消息，用户发送「开始」触发画图

4. **引用消息**：引用消息发指令时，被引用的消息和引用消息视为一条消息，遵循上述规则

### 高级用法

1. **@用户**：所有 @ 会被替换为对应用户的头像

2. **LoRA 指定**：模型 `qwen image` 和 `z-image` 系列支持使用 `#lora名#` 指定 LoRA
   - 格式：`#xx/xxxx#`
   - 可用 LoRA 列表：[ModelScope](https://www.modelscope.cn/models?tabKey=other&baseModel=adapter:MusePublic/Qwen-image)（约 8000+ 个）

3. **提示词润色**：在提示词中包含「润色」，会自动调用 AI 模型优化提示词
   - 仅 `qwen image` 和 `z-image` 系列支持

4. **分辨率指定**：在提示词中包含分辨率相关词汇
   - 支持格式：`1024x1024`、`9:16`、`横屏`、`竖屏` 等
   - 注意：并非所有模型都支持此功能

## 文档

更多详细文档请查看 [docs/](./docs/) 目录：

- [架构文档](./docs/architecture.md) - 插件架构和 API 参考
- [WebUI 开发文档](./docs/webui.md) - 前端开发指南

## License

MIT
